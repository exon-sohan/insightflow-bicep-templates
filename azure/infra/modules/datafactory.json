{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "90935902048162976"
    }
  },
  "parameters": {
    "dataFactoryName": {
      "type": "string",
      "metadata": {
        "description": "Data Factory name"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for resources"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account name"
      }
    },
    "storageAccountId": {
      "type": "string",
      "metadata": {
        "description": "Storage Account resource ID"
      }
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI"
      }
    },
    "salesforceSourceObject": {
      "type": "string",
      "metadata": {
        "description": "Salesforce source object API name"
      }
    },
    "salesforceDestinationObject": {
      "type": "string",
      "metadata": {
        "description": "Salesforce destination object API name for AI insights"
      }
    },
    "salesforceApiVersion": {
      "type": "string",
      "defaultValue": "60.0",
      "metadata": {
        "description": "Salesforce API version"
      }
    },
    "salesforceQuery": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Custom SOQL query (optional)"
      }
    }
  },
  "variables": {
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
  },
  "resources": [
    {
      "type": "Microsoft.DataFactory/factories",
      "apiVersion": "2018-06-01",
      "name": "[parameters('dataFactoryName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
      "name": "[guid(parameters('storageAccountId'), resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), variables('storageBlobDataContributorRoleId'))]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), '2018-06-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/linkedservices",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'AzureBlobStorage')]",
      "properties": {
        "type": "AzureBlobStorage",
        "typeProperties": {
          "connectionString": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value, environment().suffixes.storage)]"
        },
        "annotations": []
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/linkedservices",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'AzureKeyVault')]",
      "properties": {
        "type": "AzureKeyVault",
        "typeProperties": {
          "baseUrl": "[parameters('keyVaultUri')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/linkedservices",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'Salesforce')]",
      "properties": {
        "type": "SalesforceV2",
        "typeProperties": {
          "environmentUrl": {
            "type": "AzureKeyVaultSecret",
            "store": {
              "referenceName": "AzureKeyVault",
              "type": "LinkedServiceReference"
            },
            "secretName": "SalesforceInstanceUrl"
          },
          "authenticationType": "OAuth2ClientCredentials",
          "clientId": {
            "type": "AzureKeyVaultSecret",
            "store": {
              "referenceName": "AzureKeyVault",
              "type": "LinkedServiceReference"
            },
            "secretName": "SalesforceClientId"
          },
          "clientSecret": {
            "type": "AzureKeyVaultSecret",
            "store": {
              "referenceName": "AzureKeyVault",
              "type": "LinkedServiceReference"
            },
            "secretName": "SalesforceClientSecret"
          },
          "apiVersion": "[parameters('salesforceApiVersion')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'AzureKeyVault')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'SalesforceCallReports')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Salesforce",
          "type": "LinkedServiceReference"
        },
        "type": "SalesforceV2Object",
        "typeProperties": {
          "objectApiName": "[parameters('salesforceSourceObject')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'Salesforce')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'BlobDataset')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "AzureBlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "Json",
        "typeProperties": {
          "location": {
            "type": "AzureBlobStorageLocation",
            "container": "datasets",
            "fileName": {
              "value": "@concat('callreports_', formatDateTime(utcnow(), 'yyyyMMdd_HHmmss'), '.json')",
              "type": "Expression"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'AzureBlobStorage')]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/pipelines",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'SalesforceCallReportPipeline')]",
      "properties": {
        "activities": [
          {
            "name": "CopyCallReportsToBlob",
            "type": "Copy",
            "typeProperties": {
              "source": {
                "type": "SalesforceV2Source",
                "SOQLQuery": {
                  "value": "@concat('SELECT Id, Name, calldetails__c, callhighlights__c, Description__c, Status__c, CreatedDate FROM ', pipeline().parameters.sourceObject, ' WHERE CreatedDate >= ', pipeline().parameters.startDate)",
                  "type": "Expression"
                }
              },
              "sink": {
                "type": "JsonSink",
                "storeSettings": {
                  "type": "AzureBlobStorageWriteSettings"
                },
                "formatSettings": {
                  "type": "JsonWriteSettings",
                  "filePattern": "arrayOfObjects"
                }
              }
            },
            "inputs": [
              {
                "referenceName": "SalesforceCallReports",
                "type": "DatasetReference"
              }
            ],
            "outputs": [
              {
                "referenceName": "BlobDataset",
                "type": "DatasetReference"
              }
            ]
          }
        ],
        "parameters": {
          "sourceObject": {
            "type": "String",
            "defaultValue": "[parameters('salesforceSourceObject')]"
          },
          "startDate": {
            "type": "String",
            "defaultValue": "LAST_N_DAYS:30"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'BlobDataset')]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'SalesforceCallReports')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/triggers",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'DailyExtractionTrigger')]",
      "properties": {
        "type": "ScheduleTrigger",
        "typeProperties": {
          "recurrence": {
            "frequency": "Day",
            "interval": 1,
            "startTime": "2024-01-01T02:00:00Z",
            "timeZone": "UTC"
          }
        },
        "pipelines": [
          {
            "pipelineReference": {
              "referenceName": "SalesforceCallReportPipeline",
              "type": "PipelineReference"
            },
            "parameters": {
              "sourceObject": "[parameters('salesforceSourceObject')]",
              "startDate": "YESTERDAY"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/pipelines', parameters('dataFactoryName'), 'SalesforceCallReportPipeline')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'SalesforceAIInsights')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Salesforce",
          "type": "LinkedServiceReference"
        },
        "type": "SalesforceV2Object",
        "typeProperties": {
          "objectApiName": "[parameters('salesforceDestinationObject')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'Salesforce')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'ProcessedInsightsBlob')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "AzureBlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "Json",
        "typeProperties": {
          "location": {
            "type": "AzureBlobStorageLocation",
            "container": "output",
            "fileName": {
              "value": "@pipeline().parameters.fileName",
              "type": "Expression"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'AzureBlobStorage')]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/pipelines",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'SalesforceWriteBackPipeline')]",
      "properties": {
        "activities": [
          {
            "name": "CopyInsightsToSalesforce",
            "type": "Copy",
            "typeProperties": {
              "source": {
                "type": "JsonSource",
                "storeSettings": {
                  "type": "AzureBlobStorageReadSettings",
                  "recursive": false
                },
                "formatSettings": {
                  "type": "JsonReadSettings"
                }
              },
              "sink": {
                "type": "SalesforceV2Sink",
                "writeBehavior": "insert",
                "writeBatchSize": 5000,
                "ignoreNullValues": false
              },
              "enableStaging": false
            },
            "inputs": [
              {
                "referenceName": "ProcessedInsightsBlob",
                "type": "DatasetReference"
              }
            ],
            "outputs": [
              {
                "referenceName": "SalesforceAIInsights",
                "type": "DatasetReference"
              }
            ]
          }
        ],
        "parameters": {
          "fileName": {
            "type": "String",
            "defaultValue": ""
          },
          "destinationObject": {
            "type": "String",
            "defaultValue": "[parameters('salesforceDestinationObject')]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'ProcessedInsightsBlob')]",
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'SalesforceAIInsights')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'DynamicSalesforceDataset')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Salesforce",
          "type": "LinkedServiceReference"
        },
        "parameters": {
          "objectApiName": {
            "type": "String"
          }
        },
        "type": "SalesforceV2Object",
        "typeProperties": {
          "objectApiName": {
            "value": "@dataset().objectApiName",
            "type": "Expression"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'Salesforce')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'DynamicBlobDataset')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "AzureBlobStorage",
          "type": "LinkedServiceReference"
        },
        "parameters": {
          "objectApiName": {
            "type": "String"
          }
        },
        "type": "Json",
        "typeProperties": {
          "location": {
            "type": "AzureBlobStorageLocation",
            "container": "datasets",
            "folderPath": {
              "value": "@dataset().objectApiName",
              "type": "Expression"
            },
            "fileName": {
              "value": "@concat(dataset().objectApiName, '_', formatDateTime(utcnow(), 'yyyyMMdd_HHmmss'), '.json')",
              "type": "Expression"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'AzureBlobStorage')]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/pipelines",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'DynamicSalesforceExtractPipeline')]",
      "properties": {
        "description": "Dynamic pipeline that extracts data from any Salesforce object with specified fields and saves to blob storage",
        "activities": [
          {
            "name": "CopyDynamicSalesforceData",
            "type": "Copy",
            "dependsOn": [],
            "policy": {
              "timeout": "0.01:00:00",
              "retry": 2,
              "retryIntervalInSeconds": 30,
              "secureOutput": false,
              "secureInput": false
            },
            "typeProperties": {
              "source": {
                "type": "SalesforceV2Source",
                "SOQLQuery": {
                  "value": "@concat('SELECT ', pipeline().parameters.fieldNames, ' FROM ', pipeline().parameters.objectApiName, if(empty(pipeline().parameters.whereClause), '', concat(' WHERE ', pipeline().parameters.whereClause)))",
                  "type": "Expression"
                },
                "includeDeletedObjects": false
              },
              "sink": {
                "type": "JsonSink",
                "storeSettings": {
                  "type": "AzureBlobStorageWriteSettings"
                },
                "formatSettings": {
                  "type": "JsonWriteSettings",
                  "filePattern": "arrayOfObjects"
                }
              },
              "enableStaging": false
            },
            "inputs": [
              {
                "referenceName": "DynamicSalesforceDataset",
                "type": "DatasetReference",
                "parameters": {
                  "objectApiName": {
                    "value": "@pipeline().parameters.objectApiName",
                    "type": "Expression"
                  }
                }
              }
            ],
            "outputs": [
              {
                "referenceName": "DynamicBlobDataset",
                "type": "DatasetReference",
                "parameters": {
                  "objectApiName": {
                    "value": "@pipeline().parameters.objectApiName",
                    "type": "Expression"
                  }
                }
              }
            ]
          }
        ],
        "parameters": {
          "objectApiName": {
            "type": "String",
            "defaultValue": "Account"
          },
          "fieldNames": {
            "type": "String",
            "defaultValue": "Id, Name"
          },
          "whereClause": {
            "type": "String",
            "defaultValue": ""
          }
        },
        "folder": {
          "name": "DynamicExtract"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'DynamicBlobDataset')]",
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'DynamicSalesforceDataset')]"
      ]
    }
  ],
  "outputs": {
    "dataFactoryName": {
      "type": "string",
      "value": "[parameters('dataFactoryName')]"
    },
    "dataFactoryId": {
      "type": "string",
      "value": "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
    },
    "dataFactoryPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), '2018-06-01', 'full').identity.principalId]"
    },
    "pipelineName": {
      "type": "string",
      "value": "SalesforceCallReportPipeline"
    },
    "writeBackPipelineName": {
      "type": "string",
      "value": "SalesforceWriteBackPipeline"
    },
    "dynamicPipelineName": {
      "type": "string",
      "value": "DynamicSalesforceExtractPipeline"
    }
  }
}