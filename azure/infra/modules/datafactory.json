{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14227476513187722130"
    }
  },
  "parameters": {
    "dataFactoryName": {
      "type": "string",
      "metadata": {
        "description": "Data Factory name"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location for resources"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account name"
      }
    },
    "storageAccountId": {
      "type": "string",
      "metadata": {
        "description": "Storage Account resource ID"
      }
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI"
      }
    },
    "salesforceSourceObject": {
      "type": "string",
      "metadata": {
        "description": "Salesforce source object API name"
      }
    }
  },
  "variables": {
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
  },
  "resources": [
    {
      "type": "Microsoft.DataFactory/factories",
      "apiVersion": "2018-06-01",
      "name": "[parameters('dataFactoryName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
      "name": "[guid(parameters('storageAccountId'), resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), variables('storageBlobDataContributorRoleId'))]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
        "principalId": "[reference(resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), '2018-06-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/linkedservices",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'AzureBlobStorage')]",
      "properties": {
        "type": "AzureBlobStorage",
        "typeProperties": {
          "serviceEndpoint": "[format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage)]",
          "accountKind": "StorageV2"
        }
      },
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), variables('storageBlobDataContributorRoleId')))]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/linkedservices",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'AzureKeyVault')]",
      "properties": {
        "type": "AzureKeyVault",
        "typeProperties": {
          "baseUrl": "[parameters('keyVaultUri')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/linkedservices",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'Salesforce')]",
      "properties": {
        "type": "SalesforceV2",
        "typeProperties": {
          "environmentUrl": {
            "type": "AzureKeyVaultSecret",
            "store": {
              "referenceName": "AzureKeyVault",
              "type": "LinkedServiceReference"
            },
            "secretName": "SalesforceInstanceUrl"
          },
          "authenticationType": "OAuth2ClientCredentials",
          "clientId": {
            "type": "AzureKeyVaultSecret",
            "store": {
              "referenceName": "AzureKeyVault",
              "type": "LinkedServiceReference"
            },
            "secretName": "SalesforceClientId"
          },
          "clientSecret": {
            "type": "AzureKeyVaultSecret",
            "store": {
              "referenceName": "AzureKeyVault",
              "type": "LinkedServiceReference"
            },
            "secretName": "SalesforceClientSecret"
          },
          "apiVersion": "52.0"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'AzureKeyVault')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'SalesforceCallReports')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "Salesforce",
          "type": "LinkedServiceReference"
        },
        "type": "SalesforceV2Object",
        "typeProperties": {
          "objectApiName": "[parameters('salesforceSourceObject')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'Salesforce')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/datasets",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'BlobDataset')]",
      "properties": {
        "linkedServiceName": {
          "referenceName": "AzureBlobStorage",
          "type": "LinkedServiceReference"
        },
        "type": "Json",
        "typeProperties": {
          "location": {
            "type": "AzureBlobStorageLocation",
            "container": "datasets",
            "fileName": {
              "value": "@concat('callreports_', formatDateTime(utcnow(), 'yyyyMMdd_HHmmss'), '.json')",
              "type": "Expression"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories/linkedservices', parameters('dataFactoryName'), 'AzureBlobStorage')]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/pipelines",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'SalesforceCallReportPipeline')]",
      "properties": {
        "activities": [
          {
            "name": "CopyCallReportsToBlob",
            "type": "Copy",
            "typeProperties": {
              "source": {
                "type": "SalesforceV2Source",
                "SOQLQuery": {
                  "value": "@concat('SELECT Id, Name, calldetails__c, callhighlights__c, Description__c, Phone__c, Email__c, Status__c, CreatedDate FROM ', pipeline().parameters.sourceObject, ' WHERE CreatedDate >= ', pipeline().parameters.startDate)",
                  "type": "Expression"
                }
              },
              "sink": {
                "type": "JsonSink",
                "storeSettings": {
                  "type": "AzureBlobStorageWriteSettings"
                },
                "formatSettings": {
                  "type": "JsonWriteSettings",
                  "filePattern": "arrayOfObjects"
                }
              }
            },
            "inputs": [
              {
                "referenceName": "SalesforceCallReports",
                "type": "DatasetReference"
              }
            ],
            "outputs": [
              {
                "referenceName": "BlobDataset",
                "type": "DatasetReference"
              }
            ]
          }
        ],
        "parameters": {
          "sourceObject": {
            "type": "String",
            "defaultValue": "[parameters('salesforceSourceObject')]"
          },
          "startDate": {
            "type": "String",
            "defaultValue": "LAST_N_DAYS:30"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'BlobDataset')]",
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/datasets', parameters('dataFactoryName'), 'SalesforceCallReports')]"
      ]
    },
    {
      "type": "Microsoft.DataFactory/factories/triggers",
      "apiVersion": "2018-06-01",
      "name": "[format('{0}/{1}', parameters('dataFactoryName'), 'DailyExtractionTrigger')]",
      "properties": {
        "type": "ScheduleTrigger",
        "typeProperties": {
          "recurrence": {
            "frequency": "Day",
            "interval": 1,
            "startTime": "2024-01-01T02:00:00Z",
            "timeZone": "UTC"
          }
        },
        "pipelines": [
          {
            "pipelineReference": {
              "referenceName": "SalesforceCallReportPipeline",
              "type": "PipelineReference"
            },
            "parameters": {
              "sourceObject": "[parameters('salesforceSourceObject')]",
              "startDate": "YESTERDAY"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]",
        "[resourceId('Microsoft.DataFactory/factories/pipelines', parameters('dataFactoryName'), 'SalesforceCallReportPipeline')]"
      ]
    }
  ],
  "outputs": {
    "dataFactoryName": {
      "type": "string",
      "value": "[parameters('dataFactoryName')]"
    },
    "dataFactoryId": {
      "type": "string",
      "value": "[resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName'))]"
    },
    "dataFactoryPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DataFactory/factories', parameters('dataFactoryName')), '2018-06-01', 'full').identity.principalId]"
    },
    "pipelineName": {
      "type": "string",
      "value": "SalesforceCallReportPipeline"
    }
  }
}